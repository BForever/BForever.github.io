<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      BForever &middot; Blog
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="BForever" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">BForever</a>
          <small>Blog</small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/2018/08/03/IFB%E4%B8%8A%E6%8C%82%E8%BD%BDNETEM/">
        Ifb上挂载netem
      </a>
    </h1>

    <time datetime="2018-08-03T00:00:00+08:00" class="post-date">03 Aug 2018</time>

    <h1 id="ifb上挂载netem">IFB上挂载NETEM</h1>
<h2 id="转发虚拟网卡的ingress">转发虚拟网卡的ingress</h2>
<h3 id="建立虚拟网卡的ingress转发到ifb0每一个pod">建立虚拟网卡的ingress转发到ifb0（每一个Pod）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev calixxxxxxxxxxx ingress
tc filter add dev calixxxxxxxxxxx parent ffff: protocol ip prio 10 u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb0
</code></pre></div></div>

<h3 id="建立ifb0的根队列htb每一个node">建立ifb0的根队列htb（每一个Node）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev ifb0 root handle 1: htb default 0
</code></pre></div></div>

<h3 id="为x号pod建立一个类1x每一个pod">为x号Pod建立一个类1:x（每一个Pod）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc class add dev ifb0 parent 1: classid 1:x htb rate 100mbps
</code></pre></div></div>

<h3 id="为podx的ipxxxx建立一个过滤器使来自该podx的流量进入子类1x每一个pod">为Podx的IPx.x.x.x建立一个过滤器，使来自该Podx的流量进入子类1:x（每一个Pod）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc filter add dev ifb0 protocol ip parent 1:0 prio 1 u32 match ip src x.x.x.x flowid 1:x
</code></pre></div></div>
<h3 id="为每一个类建立一个netem队列x11每一个pod">为每一个类建立一个netem队列x+1:1（每一个Pod）</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev ifb0 parent 1:1 handle x+1: netem delay 100ms
</code></pre></div></div>
<h2 id="转发虚拟网卡的egress">转发虚拟网卡的egress</h2>
<h3 id="为虚拟网卡的egress建立htb队列1每一个pod">为虚拟网卡的egress建立HTB队列1:（每一个Pod）</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev calixxxxxxxxxxx root handle 1: htb default 1
</code></pre></div></div>

<h3 id="为htb建立子类11每一个pod">为HTB建立子类1:1（每一个Pod）</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc class add dev calix parent 1: classid 1:1 htb rate 100mbps
</code></pre></div></div>

<h3 id="为子类建立队列每一个pod">为子类建立队列（每一个Pod）</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev calix parent 1:1 pfifo limit 1600
</code></pre></div></div>

<h3 id="转发到ifb1每一个pod">转发到IFB1（每一个Pod）</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc filter add dev calix parent 1: proto ip prio 1 u32 match u32 0 0 flowid 1:1 action mirred egress redirect dev ifb1
</code></pre></div></div>

<h3 id="建立ifb1的根队列htb每一个node">建立ifb1的根队列htb（每一个Node）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev ifb1 root handle 1: htb default 0
</code></pre></div></div>

<h3 id="为x号pod建立一个类1x每一个pod-1">为x号Pod建立一个类1:x（每一个Pod）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc class add dev ifb1 parent 1: classid 1:x htb rate 100mbps
</code></pre></div></div>

<h3 id="为podx的ipxxxx建立一个过滤器使来自该podx的流量进入子类1x每一个pod-1">为Podx的IPx.x.x.x建立一个过滤器，使来自该Podx的流量进入子类1:x（每一个Pod）：</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc filter add dev ifb1 protocol ip parent 1:0 prio 1 u32 match ip src x.x.x.x flowid 1:x
</code></pre></div></div>
<h3 id="为每一个类建立一个netem队列x11每一个pod-1">为每一个类建立一个netem队列x+1:1（每一个Pod）</h3>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tc qdisc add dev ifb1 parent 1:1 handle x+1: netem delay 100ms
</code></pre></div></div>

  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page3">Older</a>
  
  
    <a class="pagination-item newer" href="/">Newer</a>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2018-08-09T16:03:03+08:00">2018</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
