<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
    
      BForever &middot; Blog
    
  </title>

  <link rel="stylesheet" href="/styles.css">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">
  <link rel="alternate" type="application/atom+xml" title="BForever" href="/atom.xml">
</head>


  <body>

    <div class="container content">
      <header class="masthead">
        <h3 class="masthead-title">
          <a href="/" title="Home">BForever</a>
          <small>Blog</small>
        </h3>
      </header>

      <main>
        <div class="posts">
  
  <article class="post">
    <h1 class="post-title">
      <a href="/2018/07/24/%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8C%85%E5%90%ABTC%E7%9A%84Alpine%E9%95%9C%E5%83%8F/">
        创建一个包含tc的alpine镜像
      </a>
    </h1>

    <time datetime="2018-07-24T00:00:00+08:00" class="post-date">24 Jul 2018</time>

    <h1 id="创建一个包含tc的alpine镜像">创建一个包含TC的Alpine镜像</h1>

<h2 id="镜像的创建">镜像的创建</h2>

<ol>
  <li>更换镜像至ustc（为了测试时的速度）</li>
  <li>安装musl-dev make gcc linux-headers bison flex以使TC可以编译</li>
  <li>拷贝进TC的源代码</li>
  <li>进入源代码文件夹进行编译</li>
  <li>运行top（或任何不自动退出的程序）以便exec进入容器</li>
</ol>

<p>Dockerfile如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM alpine

RUN rm /etc/apk/repositories
RUN echo -e "http://mirrors.ustc.edu.cn/alpine/v3.8/main\nhttp://mirrors.ustc.edu.cn/alpine/v3.8/community" &gt; /etc/apk/repositories

RUN set -ex \
        &amp;&amp; apk update &amp;&amp; apk add --no-cache --virtual .build-deps \
                musl-dev \
                make \
                gcc \
                linux-headers \
                bison \
                flex

ADD iproute /code/iproute
RUN cd code/iproute &amp;&amp; make
CMD top
</code></pre></div></div>

<h2 id="部署用yaml的设置">部署用yaml的设置</h2>

<h3 id="tc内核通信权限设置">TC内核通信权限设置</h3>
<p>由于TC与内核通信并更改网络设置，需要提高容器权限，这需要在YAML文件中进行设置：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>spec:
  containers:
    securityContext:
      privileged: true
</code></pre></div></div>
<p>这样容器内的TC才有权限通过netlink与内核进行通信</p>

<h3 id="网络设置">网络设置</h3>

<p>TC所在的POD需要能够设置该Node的所有网卡，因此需要设置为hostNetwork网络，另外需要设置DNS以使Pod能以POD的身份访问service</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
</code></pre></div></div>

<p>最后的部署用的YAML如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-deployment
spec:
  selector:
    matchLabels:
      app: test
  replicas: 1
  template:
    metadata:
      labels:
        app: test
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: test
        image: foo
        imagePullPolicy: Never
        securityContext:
          privileged: true
</code></pre></div></div>


  </article>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page7">Older</a>
  
  
    <a class="pagination-item newer" href="/page5">Newer</a>
  
</div>

      </main>

      <footer class="footer">
        <small>
          &copy; <time datetime="2018-08-10T16:38:04+08:00">2018</time>. All rights reserved.
        </small>
      </footer>
    </div>

    
  </body>
</html>
